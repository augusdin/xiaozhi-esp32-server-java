# ================================
# Stage 1: Maven Dependencies Cache
# ================================
FROM eclipse-temurin:21-jdk AS deps-builder

# 安装Maven
RUN apt-get update && apt-get install -y --no-install-recommends \
    maven \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# 先复制pom.xml，利用Docker层缓存优化依赖下载
COPY pom.xml ./
RUN mvn dependency:go-offline -B

# ================================
# Stage 2: Application Builder  
# ================================
FROM eclipse-temurin:21-jdk AS app-builder

# 安装Maven
RUN apt-get update && apt-get install -y --no-install-recommends \
    maven \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# 复制缓存的依赖
COPY --from=deps-builder /root/.m2 /root/.m2

# 复制源代码并构建
COPY ./src ./src
COPY ./db ./db
COPY pom.xml ./

# 构建应用，跳过测试提高速度
RUN mvn clean package -DskipTests -B -q

# 提取版本号
RUN APP_VERSION=$(grep -A1 "<artifactId>xiaozhi.server</artifactId>" pom.xml | \
    grep "<version>" | sed -e 's/<version>//' -e 's/<\/version>//' -e 's/[[:space:]]//g') && \
    echo "APP_VERSION=${APP_VERSION}" > /build/app_version.env

# ================================
# Stage 3: Runtime Environment
# ================================
FROM eclipse-temurin:21-jre AS runtime

# 安装运行时依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 复制应用JAR文件
COPY --from=app-builder /build/target/xiaozhi.server-*.jar /app/
COPY --from=app-builder /build/app_version.env /app/

# 创建models目录并复制必要的VAD模型
RUN mkdir -p /app/models
COPY ./models/silero_vad.onnx /app/models/silero_vad.onnx

# 创建优化的启动脚本 - 适配2GB RAM环境，使用原版格式
RUN echo '#!/bin/bash\n\
if [ -f /app/app_version.env ]; then\n\
  . /app/app_version.env\n\
fi\n\
echo "Starting Xiaozhi Server version: ${APP_VERSION}"\n\
java -Xms128m -Xmx400m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=prod -jar /app/xiaozhi.server-${APP_VERSION}.jar\n\
' > /app/start.sh && chmod +x /app/start.sh

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8091/actuator/health || exit 1

# 使用bash执行启动脚本 - 保持原版格式
CMD ["/bin/bash", "/app/start.sh"]